version: "3.8"

services:
  # Customer Web - displays pages
  hidros-b2b-react:
    image: crowdechain/b2b-40:1.0.1
    ports:
      - target: 3000
        published: 3000
        protocol: tcp
        mode: host
    env_file:
      - ./.env.runtime
    environment:
      PORT: "3000"
      HOSTNAME: 0.0.0.0
      NODE_ENV: production
      # MongoDB connection - customer_web code reads HIDROS_MONGO_URL
      HIDROS_MONGO_URL: "mongodb://root:root@mongo:27017/?authSource=admin"
      HIDROS_MONGO_DB: "hdr-api-it"
      HIDROS_MONGO_MIN_POOL_SIZE: "0"
      HIDROS_MONGO_MAX_POOL_SIZE: "50"
    networks:
      - default
      - dfl_internal_v2
    deploy:
      replicas: 1
      restart_policy: { condition: on-failure }
      update_config:
        order: stop-first
        parallelism: 1
        delay: 5s
      resources:
        limits: { cpus: "2.0", memory: 1024M }
        reservations: { memory: 256M }
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000',r=>process.exit(r.statusCode<500?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  # VINC Storefront - edits/builds pages (same database!)
  vinc-storefront:
    image: crowdechain/storefront-builder:1.0.3
    ports:
      - target: 3000
        published: 3001
        protocol: tcp
        mode: host
    env_file:
      - ./.env.runtime
    environment:
      PORT: "3000"
      HOSTNAME: 0.0.0.0
      NODE_ENV: production
      # MongoDB connection - vinc-storefront code reads VINC_MONGO_URL
      # SAME database as customer_web (hdr-api-it) - they share data!
      VINC_MONGO_URL: "mongodb://root:root@mongo:27017/?authSource=admin"
      VINC_MONGO_DB: "hdr-api-it"
      VINC_MONGO_MIN_POOL_SIZE: "0"
      VINC_MONGO_MAX_POOL_SIZE: "50"
      # Redis for job queues
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
    networks:
      - default
      - dfl_internal_v2
    deploy:
      replicas: 1
      restart_policy: { condition: on-failure }
      update_config:
        order: stop-first
        parallelism: 1
        delay: 5s
      resources:
        limits: { cpus: "2.0", memory: 1024M }
        reservations: { memory: 256M }
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000',r=>process.exit(r.statusCode<500?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

networks:
  dfl_internal_v2:
    external: true
    name: dflapi-app_dfl_internal_v2
