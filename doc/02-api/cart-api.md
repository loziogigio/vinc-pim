# Cart API Guide

This guide covers the Cart/Order API for B2B e-commerce operations.

## Overview

In VINC Commerce Suite, a **cart** is simply an order with `status: "draft"`. The same document evolves through the lifecycle:

```
draft (cart) → pending → confirmed → shipped
```

### Key Concepts

| Field | Description |
|-------|-------------|
| `order_id` | Unique identifier (nanoid, 12 chars) |
| `cart_number` | Sequential number per year (assigned when cart is created) |
| `order_number` | Sequential number per year (assigned when order is confirmed) |
| `status` | `draft` = cart, then `pending`, `confirmed`, `shipped`, `cancelled` |
| `is_current` | `true` = the active working cart for this customer+address |
| `customer_code` | External/ERP customer code |
| `shipping_address_code` | External/ERP address code |

### Customer Identifiers

| Field           | Generated By            | Example          | Purpose                              |
| --------------- | ----------------------- | ---------------- | ------------------------------------ |
| `customer_id`   | **System (nanoid)**     | `cust_abc123def` | Internal unique ID for DB relations  |
| `external_code` | **ERP/External**        | `CLI-001`        | Code from ERP system for integration |
| `public_code`   | **System (sequential)** | `C-00001`        | Human-readable code for display      |

- **`customer_id`**: Auto-generated unique ID (nanoid). Used internally for all DB references. **Cannot be provided in request.**
- **`external_code`** (also called `customer_code`): Provided by external ERP system. Used for lookup/sync. **Can be provided in request.**
- **`public_code`**: Human-readable code for display. **Can be provided in request OR auto-generated** (C-00001, C-00002...) if not provided.

---

## 1. Get or Create Active Cart

### Endpoint

```
POST /api/b2b/cart/active
```

### Description

Find the current cart by external codes (`customer_code` + `address_code`), or create a new one if it doesn't exist.

### Request Payload

```json
{
  "customer_code": "CLI-001",
  "address_code": "ADDR-001",
  "pricelist_type": "VEND",
  "pricelist_code": "02",
  "customer": {
    "external_code": "CLI-001",
    "public_code": "C-00001",
    "email": "cliente@example.com",
    "customer_type": "business",
    "is_guest": false,
    "first_name": "Mario",
    "last_name": "Rossi",
    "company_name": "Acme Corporation",
    "phone": "+39 02 1234567",
    "legal_info": {
      "vat_number": "IT12345678901",
      "fiscal_code": "12345678901",
      "pec_email": "acme@pec.it",
      "sdi_code": "XXXXXXX"
    }
  },
  "address": {
    "external_code": "ADDR-001",
    "address_type": "delivery",
    "label": "Main Warehouse",
    "recipient_name": "Mario Rossi",
    "street_address": "Via Roma 123",
    "city": "Milano",
    "province": "MI",
    "postal_code": "20100",
    "country": "IT",
    "phone": "+39 02 1234567",
    "delivery_notes": "Ring bell twice"
  }
}
```

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `customer_code` | string | **Required** - External customer code for lookup |
| `address_code` | string | **Required** - External address code for lookup |

### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `pricelist_type` | string | External pricelist type (e.g., "VEND") |
| `pricelist_code` | string | External pricelist code (e.g., "02") |
| `customer` | object | Customer details (used to create if not found) |
| `address` | object | Address details (used to create if not found) |

### Response

```json
{
  "success": true,
  "cart_id": "abc123def456",
  "order_id": "abc123def456",
  "is_new": true,
  "customer": {
    "customer_id": "cust_abc123",
    "external_code": "CLI-001",
    "public_code": "C-00001",
    "is_new": false
  },
  "address": {
    "address_id": "addr_xyz789",
    "address_code": "ADDR-001",
    "is_new": false
  },
  "order": {
    "order_id": "abc123def456",
    "cart_number": 15,
    "year": 2025,
    "status": "draft",
    "is_current": true,
    "customer_id": "cust_abc123",
    "customer_code": "CLI-001",
    "items": [],
    "order_total": 0
  }
}
```

### Minimal Payload (Existing Customer & Address)

If customer and address already exist:

```json
{
  "customer_code": "CLI-001",
  "address_code": "ADDR-001"
}
```

---

## 2. Add Items to Cart

### Endpoint

```
POST /api/b2b/orders/{order_id}/items
```

### Description

Add a single item to the cart. If the `entity_code` already exists, the quantity is **added** to the existing item.

### Single Item Payload

```json
{
  "entity_code": "PROD-001",
  "sku": "SKU-001",
  "name": "Hydraulic Pump 50L/min",
  "quantity": 10,
  "list_price": 450.00,
  "unit_price": 380.00,
  "vat_rate": 22,
  "brand": "HydroMax",
  "category": "Pumps",
  "image_url": "https://example.com/pump.jpg",
  "quantity_unit": "pz",
  "min_order_quantity": 5,
  "pack_size": 5,
  "added_from": "catalog",
  "added_via": "quick_order"
}
```

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `entity_code` | string | Product unique identifier |
| `sku` | string | Stock keeping unit |
| `name` | string | Product name |
| `quantity` | number | Quantity to add (must be > 0) |
| `list_price` | number | Original catalog price |
| `unit_price` | number | Price after discounts |
| `vat_rate` | number | VAT percentage (22, 10, 4, 0) |

### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `brand` | string | Product brand |
| `category` | string | Product category |
| `image_url` | string | Product image URL |
| `quantity_unit` | string | Unit of measure (pz, kg, box) |
| `min_order_quantity` | number | Minimum order quantity |
| `pack_size` | number | Pack size (qty must be multiple) |
| `promo_price` | number | Special promotional price |
| `discounts` | array | Discount tiers |
| `promo_code` | string | External promo code |
| `promo_row` | number | External promo row |
| `is_gift_line` | boolean | Is this a gift item? |
| `added_from` | string | Source: pdp, plp, search, quick_order |
| `added_via` | string | Action: main_cta, row_action, carousel |

### Response

```json
{
  "success": true,
  "order": {
    "order_id": "abc123def456",
    "items": [
      {
        "line_number": 10,
        "entity_code": "PROD-001",
        "sku": "SKU-001",
        "name": "Hydraulic Pump 50L/min",
        "quantity": 10,
        "list_price": 450.00,
        "unit_price": 380.00,
        "vat_rate": 22,
        "line_gross": 4500.00,
        "line_net": 3800.00,
        "line_vat": 836.00,
        "line_total": 4636.00
      }
    ],
    "subtotal_gross": 4500.00,
    "subtotal_net": 3800.00,
    "total_vat": 836.00,
    "order_total": 4636.00
  },
  "item": {
    "line_number": 10,
    "entity_code": "PROD-001",
    "quantity": 10
  }
}
```

---

## 3. Add Multiple Items (Batch)

To add multiple items, make multiple sequential POST requests:

```javascript
const items = [
  {
    entity_code: "PROD-001",
    sku: "SKU-001",
    name: "Hydraulic Pump 50L/min",
    quantity: 10,
    list_price: 450.00,
    unit_price: 380.00,
    vat_rate: 22
  },
  {
    entity_code: "PROD-002",
    sku: "SKU-002",
    name: "Directional Control Valve",
    quantity: 5,
    list_price: 280.00,
    unit_price: 240.00,
    vat_rate: 22
  },
  {
    entity_code: "PROD-003",
    sku: "SKU-003",
    name: "High Pressure Hose 10m",
    quantity: 20,
    list_price: 85.00,
    unit_price: 72.00,
    vat_rate: 22
  }
];

// Add items sequentially
for (const item of items) {
  await fetch(`/api/b2b/orders/${orderId}/items`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(item)
  });
}
```

### Smart Merge Logic

When adding items, the system uses **smart merging**. Quantities are merged **only if ALL these fields match**:

| Field | Description |
|-------|-------------|
| `entity_code` | Same product |
| `promo_code` | Same promo code |
| `promo_row` | Same promo row |
| `pack_size` | Same pack size |
| `unit_price` | Same price |

**If any field differs, a NEW line is created:**

```json
// Line 10: Product A, pack=1, no promo
{ "entity_code": "PROD-001", "pack_size": 1, "unit_price": 15.00, ... }

// Line 20: Same product, bigger pack = different line
{ "entity_code": "PROD-001", "pack_size": 10, "unit_price": 12.00, ... }

// Line 30: Same product, with promo = different line
{ "entity_code": "PROD-001", "pack_size": 1, "unit_price": 15.00, "promo_code": "SUMMER2025", ... }
```

This allows:
- Same product with different pack sizes (bulk pricing)
- Same product with different promos
- Same product with different prices

---

## 4. Update Items (Batch)

### Endpoint

```
PATCH /api/b2b/orders/{order_id}/items
```

### Description

Update one or more items in the cart. Items are identified by `line_number`.

### Request Payload

```json
{
  "items": [
    { "line_number": 10, "quantity": 25 },
    { "line_number": 20, "quantity": 15 },
    { "line_number": 30, "quantity": 5 }
  ]
}
```

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `items` | array | Array of items to update |
| `items[].line_number` | number | Line number to identify the item |
| `items[].quantity` | number | New quantity (must be > 0) |

### Response

```json
{
  "success": true,
  "order": {
    "order_id": "abc123def456",
    "items": [
      {
        "line_number": 10,
        "entity_code": "PROD-001",
        "quantity": 25,
        "line_gross": 11250.00,
        "line_net": 9500.00,
        "line_vat": 2090.00,
        "line_total": 11590.00
      }
    ],
    "subtotal_gross": 11250.00,
    "subtotal_net": 9500.00,
    "total_vat": 2090.00,
    "order_total": 11590.00
  },
  "results": [
    { "line_number": 10, "success": true },
    { "line_number": 20, "success": true },
    { "line_number": 30, "success": false, "error": "Item not found" }
  ]
}
```

### Validation

- Quantity must be > 0 (use DELETE to remove item)
- Quantity must respect `min_order_quantity` if set
- Quantity must be multiple of `pack_size` if set

### Error Examples

```json
// Quantity too low
{ "error": "Quantity must be greater than 0. Use DELETE to remove." }

// Below minimum
{ "error": "Minimum order quantity is 5" }

// Not a multiple of pack size
{ "error": "Quantity must be a multiple of 5" }
```

---

## 5. Remove Items (Batch)

### Endpoint

```
DELETE /api/b2b/orders/{order_id}/items
```

### Description

Remove one or more items from the cart. Items are identified by `line_number`.

### Request Payload (Option 1: items array)

```json
{
  "items": [
    { "line_number": 10 },
    { "line_number": 30 }
  ]
}
```

### Request Payload (Option 2: line_numbers array)

```json
{
  "line_numbers": [10, 30]
}
```

### Response

```json
{
  "success": true,
  "order": {
    "order_id": "abc123def456",
    "items": [...],
    "order_total": 4636.00
  },
  "results": [
    { "line_number": 10, "success": true },
    { "line_number": 30, "success": true }
  ],
  "message": "Removed 2 item(s)"
}
```

---

## 6. Get Cart Details

### Endpoint

```
GET /api/b2b/orders/{order_id}
```

### Response

```json
{
  "success": true,
  "order": {
    "order_id": "abc123def456",
    "cart_number": 15,
    "year": 2025,
    "status": "draft",
    "is_current": true,
    "customer_id": "cust_abc123",
    "customer_code": "CLI-001",
    "items": [...],
    "subtotal_gross": 4500.00,
    "subtotal_net": 3800.00,
    "total_discount": 700.00,
    "total_vat": 836.00,
    "shipping_cost": 0,
    "order_total": 4636.00,
    "created_at": "2025-12-23T10:30:00.000Z",
    "updated_at": "2025-12-23T11:45:00.000Z"
  }
}
```

---

## 7. List Orders/Carts

### Endpoint

```
GET /api/b2b/orders
```

### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | number | Page number (default: 1) |
| `limit` | number | Items per page (default: 20) |
| `status` | string | Filter by status: draft, pending, confirmed, shipped, cancelled |
| `year` | number | Filter by year |
| `customer_id` | string | Filter by customer |
| `cart_number` | number | Filter by cart number |
| `public_code` | string | Filter by customer public code |
| `customer_code` | string | Filter by ERP code |
| `is_current` | boolean | Filter by active cart: true/false |
| `date_from` | string | Filter from date (ISO) |
| `date_to` | string | Filter to date (ISO) |

### Example: Get All Active Carts

```
GET /api/b2b/orders?status=draft&is_current=true
```

### Response

```json
{
  "success": true,
  "orders": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "pages": 3
  },
  "stats": {
    "draft": 5,
    "pending": 12,
    "confirmed": 20,
    "shipped": 8,
    "cancelled": 0,
    "total": 45,
    "totalValue": 125680.50
  }
}
```

---

## Complete Workflow Example

```javascript
// 1. Get or create cart
const cartResponse = await fetch("/api/b2b/cart/active", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    customer_code: "CLI-001",
    address_code: "ADDR-001"
  })
});
const { order_id } = await cartResponse.json();

// 2. Add items
const addResponse = await fetch(`/api/b2b/orders/${order_id}/items`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    entity_code: "PROD-001",
    sku: "SKU-001",
    name: "Hydraulic Pump",
    quantity: 10,
    list_price: 450.00,
    unit_price: 380.00,
    vat_rate: 22
  })
});
const { item } = await addResponse.json();
const lineNumber = item.line_number; // Use this for update/delete

// 3. Update quantity (using line_number)
await fetch(`/api/b2b/orders/${order_id}/items`, {
  method: "PATCH",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    items: [{ line_number: lineNumber, quantity: 15 }]
  })
});

// 4. Remove item (using line_number)
await fetch(`/api/b2b/orders/${order_id}/items`, {
  method: "DELETE",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    line_numbers: [lineNumber]
  })
});

// 5. Get cart details
const cartDetails = await fetch(`/api/b2b/orders/${order_id}`);
```

---

## Price Calculation

Prices are calculated automatically:

| Field | Calculation |
|-------|-------------|
| `line_gross` | `quantity × list_price` |
| `line_net` | `quantity × unit_price` |
| `line_vat` | `line_net × (vat_rate / 100)` |
| `line_total` | `line_net + line_vat` |
| `total_discount` | `subtotal_gross - subtotal_net` |
| `order_total` | `subtotal_net + total_vat + shipping_cost` |

---

## Error Responses

| Status | Error |
|--------|-------|
| 400 | Bad request (missing fields, invalid data) |
| 401 | Unauthorized (not logged in) |
| 404 | Order or item not found |
| 500 | Internal server error |

### Example Error

```json
{
  "error": "Missing required fields: entity_code, sku"
}
```
